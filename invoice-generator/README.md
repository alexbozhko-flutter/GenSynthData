# Feiler Document Generator

Система генерации документов для компании Feiler. Позволяет создавать различные типы документов в форматах HTML и PDF с использованием единой системы шаблонов и данных из PostgreSQL.

## Особенности

- Единая система шаблонов для всех типов документов
- Поддержка многостраничных документов
- Автоматическая генерация HTML и PDF форматов
- Гибкая система стилей и форматирования
- Поддержка шрифтов и изображений
- Масштабируемая архитектура для добавления новых типов документов
- Прямая интеграция с базой данных PostgreSQL
- Отдельное хранение SQL запросов для лучшей поддерживаемости

## Структура проекта

```
GenSynthData/
└── invoice-generator/
    ├── README.md                  # Документация проекта
    ├── requirements.txt           # Зависимости Python
    ├── Database/                  # Файлы базы данных
    │   └── scheme.ddl            # Схема базы данных
    ├── templates/                 # Шаблоны документов
    │   ├── base/                 # Базовые классы и утилиты
    │   │   ├── __init__.py
    │   │   ├── generator.py      # Базовый класс генератора
    │   │   └── utils.py         # Общие утилиты
    │   └── invoice/             # Шаблон 001: Инвойс
    │       ├── __init__.py
    │       ├── generator.py     # Генератор инвойса
    │       └── feiler/         # Шаблон Feiler
    │           ├── generator.py # Специфичный генератор Feiler
    │           └── template.html # HTML шаблон Feiler
    ├── data/                    # Данные
    │   ├── sample/             # Примеры (игнорируются git)
    │   └── output/             # Сгенерированные файлы (игнорируются git)
    └── scripts/                # Скрипты
        ├── sql/               # SQL запросы
        │   └── fetch_invoice_data.sql  # Запрос данных инвойса
        ├── generate_invoice_from_sql.py # Генерация инвойса из БД
        ├── debug_parameters.py  # Отладка параметров продуктов
        ├── get_invoice_id.py   # Получение тестового ID инвойса
        └── get_product_id.py   # Получение тестового ID продукта
```

## Скрипты

### Основные скрипты

1. `generate_invoice_from_sql.py`
   - Основной скрипт для генерации инвойсов
   - Получает данные из PostgreSQL
   - Генерирует HTML и PDF версии документа
   - Использование: `python generate_invoice_from_sql.py <invoice_id>`

2. `debug_parameters.py`
   - Отладочный скрипт для проверки параметров продуктов
   - Показывает детальную информацию о продукте и его параметрах
   - Использование: `python debug_parameters.py <product_id>`

3. `get_invoice_id.py`
   - Утилита для получения тестового ID инвойса
   - Показывает базовую информацию о найденном инвойсе
   - Использование: `python get_invoice_id.py`

4. `get_product_id.py`
   - Утилита для получения тестового ID продукта
   - Показывает базовую информацию о найденном продукте
   - Использование: `python get_product_id.py`

### SQL запросы

Все SQL запросы хранятся в директории `scripts/sql/` для лучшей организации и поддерживаемости кода:

1. `fetch_invoice_data.sql`
   - Основной запрос для получения данных инвойса
   - Включает информацию о товарах, количествах и ценах
   - Поддерживает параметризацию через ID инвойса
   - Автоматически объединяет данные из нескольких таблиц

## База данных

Проект использует PostgreSQL в качестве базы данных. Схема базы данных находится в файле `Database/scheme.ddl`. Основные таблицы для работы с документами:

- `latest.invoicesin` - приходные накладные
- `latest.invoiceincontents` - содержимое приходных накладных
- `latest.invoicesout` - расходные накладные
- `latest.invoiceoutcontents` - содержимое расходных накладных
- `latest.products` - справочник товаров
- `latest.shops` - справочник магазинов

Все таблицы находятся в схеме `latest`. Подробное описание структуры таблиц и их связей можно найти в файле схемы.

## Шаблоны документов

### 001 - Invoice (Инвойс)
- Основной шаблон для выставления счетов
- Поддержка многостраничности (до 25 позиций на документ)
- Автоматическая разбивка товаров по страницам:
  - Первая страница: до 8 позиций
  - Последующие страницы: до 12 позиций
- Поддержка форматов HTML и PDF
- Автоматическая нумерация страниц
- Встроенные шрифты и стили

## Установка и использование

1. Установка зависимостей:
```bash
pip install -r requirements.txt
```

2. Настройка базы данных:
```bash
# Создание базы данных
createdb feiler_db

# Применение схемы
psql -d feiler_db -f Database/scheme.ddl
```

3. Базовое использование:
```python
from templates.invoice import InvoiceGenerator

# Создание генератора
generator = InvoiceGenerator()

# Подготовка данных
data = {
    "SENDER": "Ernst Feiler GmbH",
    "CUSTOMER_FULL_ADDRESS": "...",
    # Другие поля данных
}

# Генерация документов
html_path, pdf_path = generator.generate_both(
    data,
    "output/invoice.html",
    "output/invoice.pdf"
)
```

4. Запуск тестового примера:
```bash
python scripts/test_invoice.py
```

## Тестирование

Для тестирования генерации инвойсов используется накладная №38, которая содержит все необходимые типы данных и форматирование:
```bash
python scripts/generate_invoice_from_sql.py 38
```

Этот инвойс используется как эталонный пример для проверки корректности форматирования и отображения данных.

## Правила разработки

1. Каждый тип документа должен:
   - Иметь уникальный трехзначный номер (например, 001 для инвойсов)
   - Располагаться в отдельной директории в `templates/`
   - Наследоваться от базового класса `BaseGenerator`
   - Иметь собственные HTML шаблоны и стили

2. Структура данных:
   - Тестовые данные размещаются в `data/sample/` (игнорируются git)
   - Сгенерированные файлы сохраняются в `data/output/` (игнорируются git)
   - Общие ресурсы (шрифты, изображения) хранятся в `assets/`
   - Схема базы данных хранится в `Database/scheme.ddl`

3. Тестирование:
   - Каждый шаблон должен иметь тестовый скрипт в директории `scripts/`
   - Тесты должны демонстрировать все основные возможности шаблона
   - Тестовые данные должны быть максимально приближены к реальным 

## Файлы данных

- `data/colors.txt` - Список цветов и их кодов для использования в инвойсах. Формат: `ColorID|Color`. Если ColorID отсутствует, используется пустое значение до разделителя. 